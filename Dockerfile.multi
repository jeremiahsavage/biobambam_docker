ARG REPOSITORY=docker.osdc.io
ARG BUILDER_TAG=3.1.0
FROM ${REPOSITORY}/ncigdc/amzn2023-builder:${BUILDER_TAG} AS builder
ENV LD_LIBRARY_PATH=/usr/local/lib

ARG VERSION

ENV URL=https://gitlab.com/german.tischler/biobambam2/repository/archive/v$VERSION.tar.gz

RUN dnf update -y \
    && dnf install -y \
        autoconf \
        g++ \
        libtool \
        pkgconf \
        zlib-devel \
        boost-devel \
    && dnf clean all \
    && rm -rf /usr/local/* \
    && curl --silent -L https://gitlab.com/german.tischler/libmaus2/-/archive/master/libmaus2-master.tar.gz\?ref\=2.0.812-release-20220919125234 -o libmaus2.tar.gz \
    && curl --silent -L https://gitlab.com/german.tischler/biobambam2/-/archive/master/biobambam2-master.tar.gz\?ref\=2.0.95-release-20190320141403 -o biobambam2.tar.gz \
    && libmaus2files=$(tar -axvf libmaus2.tar.gz) \
    && libmaus2dir=$(echo ${libmaus2files} | cut -f1 -d" ") \
    && cd ${libmaus2dir} \
    && libtoolize \
    && aclocal \
    && autoreconf -i -f \
    && ./configure \
    && make -j4 \
    && make install \
    && cd ../ \
    && rm -rf ${libmaus2dir} libmaus2.tar.gz \
    && biobambam2files=$(tar -axvf biobambam2.tar.gz) \
    && biobambam2dir=$(echo ${biobambam2files} | cut -f1 -d" ") \
    && cd ${biobambam2dir} \
    && export LIBMAUSPREFIX=/usr/local \
    && autoreconf -i -f \
    && ./configure --with-libmaus2=${LIBMAUSPREFIX} \
    && make -j4 \
    && make install \
    && cd ../ \
    && rm -rf ${biobambam2dir} biobambam2.tar.gz \
    && dnf remove -y \
        autoconf \
        curl \
        g++ \
        libtool \
        pkgconf \
        zlib-devel \
        boost-devel \
    && dnf autoremove -y \
    && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

# For a multi-stage build

FROM ${REPOSITORY}/ncigdc/amzn2023:${BUILDER_TAG}

COPY --from=builder /usr/local/* /usr/local/
